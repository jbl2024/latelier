<template>
  <v-dialog
    v-model="showDialog"
    class="detail"
    max-width="640"
    :fullscreen="$vuetify.breakpoint.xsOnly"
  >
    <v-card class="new-user">
      <v-toolbar dark color="primary">
        <v-btn
          v-shortkey="['esc']"
          icon
          text
          @click="close()"
          @shortkey="close()"
        >
          <v-icon>mdi-close</v-icon>
        </v-btn>
        <v-toolbar-title>
          <span>{{ $t("New user") }}</span>
        </v-toolbar-title>
      </v-toolbar>
      <v-card-text>
        <v-form v-model="valid" class="form" @submit.prevent>
          <v-container grid-list-md>
            <v-layout wrap>
              <v-flex xs12 sm6 md6>
                <v-switch
                  v-model="user.isActive"
                  color="accent"
                  :label="`${
                    user.isActive
                      ? $t('Account activated')
                      : $t('Account deactivated')
                  }`"
                />
              </v-flex>
              <v-flex xs12 sm6 md6>
                <v-switch
                  v-model="user.isConfirmed"
                  color="accent"
                  :label="`${
                    user.isConfirmed
                      ? $t('Confirmed email')
                      : $t('Unconfirmed email')
                  }`"
                />
              </v-flex>
              <v-flex xs12>
                <v-divider />
              </v-flex>

              <v-flex xs12 sm6 md6>
                <v-text-field
                  v-model="user.profile.firstName"
                  :label="$t('First name')"
                />
              </v-flex>
              <v-flex xs12 sm6 md6>
                <v-text-field
                  v-model="user.profile.lastName"
                  :label="$t('Last name')"
                />
              </v-flex>
              <v-flex xs12>
                <v-text-field
                  v-model="user.email"
                  :label="$t('Email')"
                  required
                  :rules="emailRules"
                />
              </v-flex>
            </v-layout>
          </v-container>
        </v-form>
      </v-card-text>
      <v-card-actions>
        <v-spacer />
        <v-btn text @click.native="close()">
          {{ $t("Close") }}
        </v-btn>
        <v-btn color="primary" :disabled="!valid" @click.native="create()">
          {{ $t("Create") }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script>
export default {
  props: {},
  i18n: {
    messages: {
      en: {
        "New user": "New user",
        "User created": "User created"
      },
      fr: {
        "New user": "Nouvel utilisateur",
        "User created": "Utilisateur crÃ©e"
      }
    }
  },
  data() {
    return {
      valid: false,
      emailRules: [
        (v) => !!v || this.$t("Email is mandatory"),
        (v) => (v.length > 1 && v.indexOf("@") > -1) || this.$t("Invalid email")
      ],
      showDialog: false,
      user: {
        profile: {
          firstName: "",
          lastName: ""
        },
        email: "",
        isActive: true,
        isConfirmed: true
      }
    };
  },
  methods: {
    open() {
      this.showDialog = true;
    },
    close() {
      this.showDialog = false;
    },
    async create() {
      try {
        await Meteor.callAsync("admin.addUser", this.user);
        this.$notify(this.$t("User created"));
        this.close();
        this.$emit("created");
      } catch (error) {
        this.$notifyError(error);
      }
    }
  }
};
</script>

<style scoped>
.deactivated {
  font-weight: bold;
}
</style>
