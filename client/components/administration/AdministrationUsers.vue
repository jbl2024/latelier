<template>
  <div class="administration-users elevation-1">
    <v-dialog
      eager
      v-model="showUserDetail"
      class="detail"
      max-width="640"
      :fullscreen="$vuetify.breakpoint.xsOnly"
    >
      <user-detail @close="closeDetail()" @saved="findUsers()" ref="userDetail"></user-detail>
    </v-dialog>
    <new-user ref="newUser" @created="findUsers()"></new-user>
    <v-container fluid class="filters">
      <v-layout row wrap>
        <v-flex xs12 sm6>
          <v-text-field
            :label="$t('Search') + '...'"
            single-line
            v-model="search"
            append-icon="search"
            clearable
            v-on:input="debouncedFilter"
          ></v-text-field>
        </v-flex>
        <v-flex sm6></v-flex>
        <v-flex xs12 sm3>
          <v-switch
            v-model="filterOnline"
            :label="$t('Online')">
          </v-switch>
        </v-flex>
        <v-flex xs12 sm3>
          <v-switch
            v-model="filterAway"
            :label="$t('Away')">
          </v-switch>
        </v-flex>
        <v-flex xs12 sm3>
        </v-flex>
      </v-layout>
    </v-container>
    <v-list subheader>
      <v-subheader inset>
        {{ pagination.totalItems}} utilisateurs
        <v-btn text icon @click="$refs.newUser.open()">
          <v-icon>add</v-icon>
        </v-btn>
      </v-subheader>
      <template v-for="user in users">
        <v-list-item :key="user._id" @click="openDetail(user)">
          <v-list-item-avatar :color="isOnline(user)">
            <span>{{ formatUserLetters(user) }}</span>
          </v-list-item-avatar>
          <v-list-item-content>
            <v-list-item-title :class="getClass(user)">{{ formatUser(user) }}</v-list-item-title>
          </v-list-item-content>
          <v-list-item-action>
            <v-btn icon ripple @click.stop="removeUser(user)">
              <v-icon>delete</v-icon>
            </v-btn>
          </v-list-item-action>
        </v-list-item>
      </template>
    </v-list>
    <div class="text-xs-center">
      <v-pagination v-if="pagination.totalPages > 0" v-model="page" :length="pagination.totalPages"></v-pagination>
    </div>
  </div>
</template>

<script>
import { Meteor } from "meteor/meteor";
import { Projects } from "/imports/api/projects/projects.js";
import { Permissions } from "/imports/api/permissions/permissions";

import usersMixin from "/imports/ui/mixins/UsersMixin.js";
import debounce from "lodash/debounce";

export default {
  name: "administration-users",
  mixins: [usersMixin],
  mounted() {
    this.findUsers();
  },
  created() {
    this.debouncedFilter = debounce(val => {
      this.search = val;
    }, 400);
  },
  watch: {
    page(page) {
      this.findUsers();
    },
    search() {
      if (this.page > 1) {
        this.page = 1;
      } else {
        this.findUsers();
      }
    },
    filterOnline() {
      this.findUsers();
    },
    filterAway() {
      this.findUsers();
    }
  },
  props: {},
  i18n: {
    messages: {
      en: {
        "Delete user?": "Delete user?",
        "User deleted": "User deleted",
        "Online": "Online",
        "Away": "Away",
      },
      fr: {
        "Delete user?": "Supprimer l'utilisateur ?",
        "User deleted": "Utilisateur supprimÃ©",
        "Online": "En ligne",
        "Away": "Absent",
      }
    }
  },  
  data() {
    return {
      search: "",
      debouncedFilter: null,
      users: [],
      showUserDetail: false,
      page: 1,
      pagination: {
        totalItems: 0,
        rowsPerPage: 0,
        totalPages: 0
      },
      filterOnline: false,
      filterAway: false
    };
  },
  methods: {
    findUsers() {
      const users = Meteor.call(
        "admin.findUsers",
        this.page,
        this.search,
        this.filterOnline,
        this.filterAway,
        (error, result) => {
          if (error) {
            console.log(error);
            return;
          }
          this.pagination.totalItems = result.totalItems;
          this.pagination.rowsPerPage = result.rowsPerPage;
          this.pagination.totalPages = this.calculateTotalPages();

          this.users = result.data;
          this.users.map(user => {
            if (!user.profile) {
              user.profile = {
                firstName: "",
                lastName: ""
              };
            }
          });
        }
      );
    },

    removeUser(user) {
      this.$confirm(this.$t("Delete user?"), {
        title: user.emails[0].address,
        cancelText: this.$t("Cancel"),
        confirmText: this.$t("Delete")
      }).then(res => {
        if (res) {
          Meteor.call("admin.removeUser", user._id, (error, result) => {
            if (error) {
              this.$store.dispatch("notifyError", error);
              return;
            }
            this.$store.dispatch("notify", this.$t('User deleted'));
            this.findUsers();
          });
        }
      });
    },

    calculateTotalPages() {
      if (
        this.pagination.rowsPerPage == null ||
        this.pagination.totalItems == null
      )
        return 0;

      return Math.ceil(
        this.pagination.totalItems / this.pagination.rowsPerPage
      );
    },

    openDetail(user) {
      this.$refs.userDetail.open(user);
      this.showUserDetail = true;
    },

    closeDetail() {
      this.showUserDetail = false;
    },

    getClass(user) {
      if (!Permissions.isActive(user)) {
        return "deactivated";
      }
      return "";
    }
  }
};
</script>

<style scoped>
.manage-user {
  overflow-y: scroll;
}

.online {
  background-color: red;
}

.manage-users {
  margin-top: 12px;
}

.deactivated {
  text-decoration: line-through;
}

.filters { 
  padding: 42px;
}
</style>